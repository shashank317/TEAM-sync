<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-black">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password â€“ TeamSync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { inter: ['Inter','sans-serif'] } } } };
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    * { transition: all .25s ease; }
    .strength-check.valid { color:#22c55e }
    .strength-check.valid svg { stroke:#22c55e }
    .strength-check.invalid { color:#ef4444 }
    .strength-check.invalid svg { stroke:#ef4444 }
    @keyframes spin { to { transform: rotate(360deg) } }
    .spinner { animation: spin 1s linear infinite }
  </style>
</head>
<body class="min-h-screen text-gray-900 dark:text-white flex items-center justify-center p-4">

  <!-- Dark Mode Toggle -->
  <button id="darkModeToggle" class="fixed top-5 right-5 w-10 h-10 rounded-full bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm shadow-md flex items-center justify-center text-xl hover:bg-gray-200 dark:hover:bg-gray-700">ğŸŒ—</button>

  <!-- Card -->
  <div class="bg-white dark:bg-gray-800/60 backdrop-blur-xl p-8 sm:p-10 rounded-2xl shadow-2xl w-full max-w-md border border-gray-200 dark:border-gray-700">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-extrabold tracking-tight text-indigo-600 dark:text-indigo-400" id="cardTitle">ğŸ” Password Reset</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-2" id="cardSubtitle">Create a new, strong password.</p>
    </div>

    <form id="resetForm" class="space-y-5" onsubmit="handleReset(event)">
      <div id="emailGroup">
        <label for="emailInput" class="block text-sm font-medium mb-2">Email Address</label>
        <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 outline-none" />
      </div>
      <div>
        <label for="newPasswordInput" class="block text-sm font-medium mb-2">New Password</label>
        <input id="newPasswordInput" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 outline-none" />
      </div>

      <!-- Strength checks -->
      <div id="strength-checker" class="pt-2 space-y-2 text-sm">
        <p id="check-length" class="strength-check invalid flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>At least 8 characters</p>
        <p id="check-lower" class="strength-check invalid flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>One lowercase letter</p>
        <p id="check-uppercase" class="strength-check invalid flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>One uppercase letter</p>
        <p id="check-number" class="strength-check invalid flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>One number</p>
        <p id="check-symbol" class="strength-check invalid flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>One symbol (!@#$%^&*)</p>
      </div>

      <button id="resetButton" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg shadow-lg font-semibold hover:scale-105 transition-transform flex items-center justify-center">
        <span class="button-text">Reset Password</span>
        <div class="spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full hidden"></div>
      </button>
    </form>

    <div class="text-center mt-6">
      <p class="text-sm text-gray-500 dark:text-gray-400">Remembered your password? <a href="/" class="text-indigo-600 dark:text-indigo-400 hover:underline font-semibold">Sign In</a></p>
    </div>

    <div id="devTokenInfo" class="mt-4 hidden text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg"></div>
  </div>

  <!-- Toast -->
  <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-[140%] z-50">
    <p id="notificationMessage">Error</p>
  </div>

  <script>
    // Element references
    const ui = {
      darkModeToggle: document.getElementById('darkModeToggle'),
      emailGroup: document.getElementById('emailGroup'),
      emailInput: document.getElementById('emailInput'),
      newPasswordInput: document.getElementById('newPasswordInput'),
      resetButton: document.getElementById('resetButton'),
      notification: document.getElementById('notification'),
      notificationMessage: document.getElementById('notificationMessage'),
      strength: {
        length: document.getElementById('check-length'),
        lower: document.getElementById('check-lower'),
        upper: document.getElementById('check-uppercase'),
        number: document.getElementById('check-number'),
        symbol: document.getElementById('check-symbol')
      },
      cardTitle: document.getElementById('cardTitle'),
      cardSubtitle: document.getElementById('cardSubtitle'),
      devTokenInfo: document.getElementById('devTokenInfo')
    };

    // Theme
    function initTheme(){
      const stored = localStorage.getItem('theme');
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = stored ? stored==='dark' : prefers;
      document.documentElement.classList.toggle('dark', isDark);
      ui.darkModeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ—';
    }
    ui.darkModeToggle.addEventListener('click',()=>{
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark':'light');
      ui.darkModeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ—';
    });

    // Toast
    let toastTimer;
    function showToast(msg, type='error'){
      clearTimeout(toastTimer);
      ui.notificationMessage.textContent = msg;
      ui.notification.classList.toggle('bg-red-500', type==='error');
      ui.notification.classList.toggle('bg-green-600', type==='success');
      ui.notification.classList.remove('translate-x-[140%]');
      toastTimer=setTimeout(()=>ui.notification.classList.add('translate-x-[140%]'),3200);
    }

    // Button loading helper
    function setBtnLoading(on){
      ui.resetButton.querySelector('.button-text').classList.toggle('hidden', on);
      ui.resetButton.querySelector('.spinner').classList.toggle('hidden', !on);
      ui.resetButton.disabled = on;
    }

    // Password strength real-time validation
    function validatePassword(){
      const pwd = ui.newPasswordInput.value;
      const checks = {
        length: pwd.length >= 8,
        lower: /[a-z]/.test(pwd),
        upper: /[A-Z]/.test(pwd),
        number: /\d/.test(pwd),
        symbol: /[!@#$%^&*]/.test(pwd)
      };
      let all=true;
      Object.entries(checks).forEach(([k,v])=>{
        const el = ui.strength[k];
        el.classList.toggle('valid', v);
        el.classList.toggle('invalid', !v);
        if(!v) all=false;
      });
      return all;
    }
    ui.newPasswordInput.addEventListener('input', validatePassword);

    // Token helpers
    function getTokenFromQuery(){
      return new URLSearchParams(window.location.search).get('token');
    }
    function hideEmailIfToken(){
      const token = getTokenFromQuery();
      if(token){
        ui.emailGroup.classList.add('hidden');
        ui.cardSubtitle.textContent = 'Enter your new password to finish resetting.';
        ui.cardTitle.textContent = 'ğŸ” Set New Password';
      }
    }

    async function requestToken(email){
      const res = await fetch('/auth/request-password-reset', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.detail || 'Failed to request reset.');
      const link = data.reset_link;
      try{
        const url = new URL(link);
        const token = url.searchParams.get('token');
        if(!token) throw new Error('Token missing in response');
        // Dev helper: show token
        ui.devTokenInfo.classList.remove('hidden');
        ui.devTokenInfo.textContent = 'Dev Token (auto-applied): '+token;
        return token;
      }catch(e){
        throw new Error('Invalid reset link format');
      }
    }

    async function performReset(token, newPassword){
      const res = await fetch('/auth/reset-password', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, new_password: newPassword })
      });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.detail || 'Failed to reset password');
      return data;
    }

    async function handleReset(e){
      e.preventDefault();
      if(!validatePassword()) { showToast('Please meet all password requirements'); return; }
      setBtnLoading(true);
      try {
        const email = ui.emailInput.value.trim();
        let token = getTokenFromQuery();
        if(!token){
          if(!email){ throw new Error('Email required'); }
          token = await requestToken(email); // auto-request + proceed
        }
        await performReset(token, ui.newPasswordInput.value);
        showToast('Password reset successful. You can now sign in.', 'success');
        // Clear form and optionally redirect after a delay
        e.target.reset();
        validatePassword();
        setTimeout(()=>{ window.location.href = '/'; }, 1800);
      } catch(err){
        showToast(err.message || 'Unexpected error');
      } finally { setBtnLoading(false); }
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      hideEmailIfToken();
      validatePassword();
    });
  </script>
</body>
</html>
