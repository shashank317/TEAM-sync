<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Analytics ‚Äì TeamSync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          animation: {
            'aurora': 'aurora 60s linear infinite',
            'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
          },
          keyframes: {
            aurora: {
              from: { 'background-position': '0% 50%' },
              to: { 'background-position': '200% 50%' },
            },
            'fade-in-up': {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hero-glow {
        background-image: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(124, 58, 237, 0.3), rgba(255, 255, 255, 0));
    }
    .aurora-bg {
        background: radial-gradient(50% 100% at 50% 50%, rgba(29, 78, 216, 0.15) 0%, rgba(29, 78, 216, 0) 100%),
                    radial-gradient(40% 80% at 20% 70%, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0) 100%),
                    radial-gradient(40% 80% at 80% 30%, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0) 100%);
        animation: aurora 20s infinite alternate;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    .skeleton { animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite }
    @keyframes pulse{ 50%{opacity:.5} }
    .modal-content, .modal-backdrop { transition: all .25s ease-in-out }
  </style>
</head>
<body class="bg-slate-950 text-gray-200 antialiased selection:bg-purple-500/50 selection:text-white">

  <!-- Background Decoratives -->
  <div class="absolute inset-0 -z-10 h-full w-full overflow-hidden">
    <div class="absolute -top-32 left-0 w-full h-[50rem] hero-glow"></div>
    <div class="absolute inset-0 aurora-bg"></div>
  </div>

<div class="flex h-screen">
  <!-- Sidebar -->
  <nav class="w-64 bg-slate-900/70 backdrop-blur-xl border-r border-white/10 flex-col p-4 hidden sm:flex">
    <div class="flex items-center gap-3 mb-8 px-2">
        <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center text-white font-bold border border-white/20">TS</div>
        <h1 class="text-xl font-extrabold tracking-tight text-white">TeamSync</h1>
    </div>
    <ul class="flex-grow space-y-1">
      <li><a href="/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>
        Dashboard</a></li>
      <li><a id="tasksNav" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-1.125 0-2.062.938-2.062 2.063v7.575c0 1.125.937 2.063 2.063 2.063h9.05c1.125 0 2.063-.938 2.063-2.063V10.313A2.25 2.25 0 0013.5 8.25H8.25z" /></svg>
        Tasks</a></li>
    </ul>
    <div class="border-t border-white/10 pt-4 mt-4 space-y-2">
      <a href="/profile" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        Profile</a>
      <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-500/10 text-red-400 hover:text-red-300 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
        Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 bg-transparent overflow-y-auto">
    <header class="sticky top-0 bg-slate-950/50 backdrop-blur-lg z-10 flex items-center justify-between p-6 border-b border-white/10">
        <div>
            <h2 id="projectTitle" class="text-2xl font-bold text-white">Project Analytics</h2>
            <p id="projectSubtitle" class="text-sm text-gray-400 mt-1">Loading project details...</p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="goBack()" class="text-sm font-medium text-purple-400 hover:underline">Back to Tasks</button>
            <button id="themeToggle" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/10">
                <span class="dark:hidden">‚òÄÔ∏è</span>
                <span class="hidden dark:inline">üåô</span>
            </button>
        </div>
    </header>

    <div id="contentArea" class="p-6 opacity-0 animate-fade-in-up">
        <!-- Loading State -->
        <div id="loadingState">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="skeleton bg-white/5 h-32 rounded-2xl"></div>
                <div class="skeleton bg-white/5 h-32 rounded-2xl"></div>
                <div class="skeleton bg-white/5 h-32 rounded-2xl"></div>
            </div>
            <div class="grid md:grid-cols-5 gap-6">
                <div class="md:col-span-3 skeleton bg-white/5 h-80 rounded-2xl"></div>
                <div class="md:col-span-2 skeleton bg-white/5 h-80 rounded-2xl"></div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center bg-red-900/30 border border-red-500/30 p-8 rounded-2xl">
            <h3 class="text-lg font-semibold text-red-300">Could Not Load Analytics</h3>
            <p class="mt-1 text-sm text-gray-400">There was an issue fetching the data. Please try again.</p>
            <button onclick="location.reload()" class="mt-6 bg-red-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-red-700">Retry</button>
        </div>

        <!-- Data State -->
        <div id="dataState" class="hidden space-y-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                    <h3 class="text-sm font-medium text-gray-400">Total Tasks</h3>
                    <p id="totalTasks" class="text-3xl font-bold mt-2">-</p>
                </div>
                <div class="bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                    <h3 class="text-sm font-medium text-gray-400">Completion Rate</h3>
                    <p id="completionRate" class="text-3xl font-bold mt-2">-</p>
                </div>
                <div class="bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                    <h3 class="text-sm font-medium text-gray-400">Tasks In Progress</h3>
                    <p id="tasksInProgress" class="text-3xl font-bold mt-2">-</p>
                </div>
            </div>
            <div class="grid lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold mb-4 text-white">Task Status Overview</h2>
                    <div class="h-80"><canvas id="barChart"></canvas></div>
                </div>
                <div class="lg:col-span-2 bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                    <h2 class="text-lg font-semibold mb-4 text-white">Task Distribution</h2>
                    <div class="h-80"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
            <div id="noDataMessage" class="hidden text-center border-2 border-dashed border-slate-700 py-12 rounded-2xl mt-8">
                 <h3 class="text-lg font-semibold text-white">No Task Data Available</h3>
                 <p class="mt-1 text-sm text-gray-400">Add tasks to this project to see analytics.</p>
            </div>
        </div>
    </div>
  </main>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-6 right-6 z-[100] hidden opacity-0 transition-opacity duration-300">
  <div id="toastInner" class="px-5 py-2.5 rounded-full text-sm font-medium shadow-2xl"></div>
</div>

<script>
    const token = localStorage.getItem('access_token');
    const qs = new URLSearchParams(window.location.search);
    const projectId = qs.get('id');
    if (!token || !projectId) { window.location.href = '/'; }

    let barChartInstance = null;
    let pieChartInstance = null;
    let analyticsData = null;

    const ui = {
        loadingState: document.getElementById('loadingState'),
        errorState: document.getElementById('errorState'),
        dataState: document.getElementById('dataState'),
        noDataMessage: document.getElementById('noDataMessage'),
        themeToggle: document.getElementById('themeToggle'),
        toast: document.getElementById('toast'),
        toastInner: document.getElementById('toastInner')
    };

    function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        if (analyticsData) renderCharts(analyticsData);
    }
    (function initTheme() { const saved = localStorage.getItem('theme'); applyTheme(saved ? saved === 'dark' : true); })();
    ui.themeToggle.addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark')));
    
    let toastTimer;
    function showToast(msg, type = 'info') {
        clearTimeout(toastTimer);
        ui.toastInner.textContent = msg;
        ui.toastInner.className = "px-5 py-2.5 rounded-full text-sm font-medium shadow-2xl backdrop-blur-sm border";
        if (type === 'error') ui.toastInner.classList.add('bg-red-500/80', 'text-white', 'border-red-400');
        else if (type === 'success') ui.toastInner.classList.add('bg-green-500/80', 'text-white', 'border-green-400');
        else ui.toastInner.classList.add('bg-slate-800/80', 'text-white', 'border-slate-600');
        ui.toast.classList.remove('hidden');
        requestAnimationFrame(() => ui.toast.classList.remove('opacity-0'));
        toastTimer = setTimeout(() => {
            ui.toast.classList.add('opacity-0');
            setTimeout(() => ui.toast.classList.add('hidden'), 300);
        }, 2300);
    }

    function goBack() {
        if (projectId) window.location.href = `/tasks?id=${projectId}`;
        else window.location.href = '/dashboard';
    }
    
    function logout(){
        localStorage.removeItem('access_token');
        fetch('/auth/logout', { method: 'POST' }).finally(() => { window.location.href = '/'; });
    }

    async function fetchAnalytics() {
        ui.loadingState.classList.remove('hidden');
        ui.errorState.classList.add('hidden');
        ui.dataState.classList.add('hidden');

        try {
            const res = await fetch(`/projects/${projectId}/analytics`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.status === 401) { logout(); return; }
            if (!res.ok) throw new Error('HTTP ' + res.status);
            analyticsData = await res.json();
            renderUI(analyticsData);
        } catch (e) {
            console.error('Analytics fetch failed', e);
            ui.loadingState.classList.add('hidden');
            ui.errorState.classList.remove('hidden');
        }
    }
    
    async function fetchProjectMeta() {
        try {
            const res = await fetch('/projects', { headers: { 'Authorization': 'Bearer ' + token } });
            if (!res.ok) return;
            const projects = await res.json();
            const project = projects.find(p => String(p.id) === String(projectId));
            if (project) {
                document.getElementById('projectTitle').textContent = `Analytics: ${project.title}`;
                document.getElementById('projectSubtitle').textContent = 'A detailed overview of task progress.';
                // Update tasks link to point to current project
                const tasksNav = document.getElementById('tasksNav');
                if(tasksNav) tasksNav.href = `/tasks?id=${projectId}`;
            }
        } catch(e) { console.error("Failed to load project metadata", e); }
    }


    function renderUI(data) {
        const pending = data.pending || 0;
        const inProg = data['in-progress'] || data.in_progress || 0;
        const done = data.done || 0;
        const total = pending + inProg + done;

        document.getElementById('totalTasks').textContent = total;
        document.getElementById('tasksInProgress').textContent = inProg;
        document.getElementById('completionRate').textContent = total ? `${((done / total) * 100).toFixed(1)}%` : '0%';

        ui.loadingState.classList.add('hidden');
        ui.dataState.classList.remove('hidden');

        if (total === 0) {
            ui.noDataMessage.classList.remove('hidden');
            return;
        }
        ui.noDataMessage.classList.add('hidden');
        renderCharts({ pending, in_progress: inProg, done });
    }

    function renderCharts(data) {
        const isDark = document.documentElement.classList.contains('dark');
        const labels = ['Pending', 'In Progress', 'Done'];
        const values = [data.pending, data.in_progress, data.done];
        const colors = [
            'rgba(250, 204, 21, 0.6)', // Yellow
            'rgba(96, 165, 250, 0.6)', // Blue
            'rgba(74, 222, 128, 0.6)' // Green
        ];
        const borderColors = [
            'rgba(250, 204, 21, 1)',
            'rgba(96, 165, 250, 1)',
            'rgba(74, 222, 128, 1)'
        ]
        const textColor = 'rgba(229, 231, 235, 0.7)';
        const gridColor = 'rgba(255, 255, 255, 0.1)';

        if (barChartInstance) barChartInstance.destroy();
        barChartInstance = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels, datasets: [{ data: values, backgroundColor: colors, borderRadius: 4 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: textColor, precision: 0 }, grid: { color: gridColor } },
                    x: { ticks: { color: textColor }, grid: { display: false } }
                }
            }
        });

        if (pieChartInstance) pieChartInstance.destroy();
        pieChartInstance = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 3, borderColor: '#0f172a', hoverOffset: 8 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: textColor, boxWidth: 12, padding: 20 } }
                },
                cutout: '65%'
            }
        });
    }

    (async function init() {
        await fetchProjectMeta();
        await fetchAnalytics();
    })();
</script>
</body>
</html>
