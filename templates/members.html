<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Project Members ‚Äì TeamSync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          animation: {
            'aurora': 'aurora 60s linear infinite',
            'fade-in-up': 'fade-in-up 0.5s ease-out forwards',
          },
          keyframes: {
            aurora: {
              from: { 'background-position': '0% 50%' },
              to: { 'background-position': '200% 50%' },
            },
            'fade-in-up': {
                '0%': { opacity: '0', transform: 'translateY(10px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hero-glow {
        background-image: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(124, 58, 237, 0.3), rgba(255, 255, 255, 0));
    }
    .aurora-bg {
        background: radial-gradient(50% 100% at 50% 50%, rgba(29, 78, 216, 0.15) 0%, rgba(29, 78, 216, 0) 100%),
                    radial-gradient(40% 80% at 20% 70%, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0) 100%),
                    radial-gradient(40% 80% at 80% 30%, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0) 100%);
        animation: aurora 20s infinite alternate;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    .skeleton { animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite }
    @keyframes pulse{ 50%{opacity:.5} }
    .modal-content, .modal-backdrop { transition: all .25s ease-in-out }
  </style>
</head>
<body class="bg-slate-950 text-gray-200 antialiased selection:bg-purple-500/50 selection:text-white">

  <!-- Background Decoratives -->
  <div class="absolute inset-0 -z-10 h-full w-full overflow-hidden">
    <div class="absolute -top-32 left-0 w-full h-[50rem] hero-glow"></div>
    <div class="absolute inset-0 aurora-bg"></div>
  </div>

<div class="flex h-screen">
  <!-- Sidebar -->
  <nav class="w-64 bg-slate-900/70 backdrop-blur-xl border-r border-white/10 flex-col p-4 hidden sm:flex">
    <div class="flex items-center gap-3 mb-8 px-2">
        <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center text-white font-bold border border-white/20">TS</div>
        <h1 class="text-xl font-extrabold tracking-tight text-white">TeamSync</h1>
    </div>
    <ul class="flex-grow space-y-1">
      <li><a href="/dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>
        Dashboard</a></li>
      <li><a id="tasksNav" href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-1.125 0-2.062.938-2.062 2.063v7.575c0 1.125.937 2.063 2.063 2.063h9.05c1.125 0 2.063-.938 2.063-2.063V10.313A2.25 2.25 0 0013.5 8.25H8.25z" /></svg>
        Tasks</a></li>
    </ul>
    <div class="border-t border-white/10 pt-4 mt-4 space-y-2">
      <a href="/profile" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white text-sm">
         <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        Profile</a>
      <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-500/10 text-red-400 hover:text-red-300 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>
        Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 bg-transparent overflow-y-auto">
    <header class="sticky top-0 bg-slate-950/50 backdrop-blur-lg z-10 flex items-center justify-between p-6 border-b border-white/10">
        <div>
            <h2 id="projectTitle" class="text-2xl font-bold text-white">Project Members</h2>
            <p id="projectSubtitle" class="text-sm text-gray-400 mt-1 hidden"></p>
        </div>
        <button id="themeToggle" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/10">
            <span class="dark:hidden">‚òÄÔ∏è</span>
            <span class="hidden dark:inline">üåô</span>
        </button>
    </header>

    <div class="p-6 space-y-8 opacity-0 animate-fade-in-up">
        <section class="grid md:grid-cols-2 gap-6">
            <div class="bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                <h2 class="text-xl font-semibold mb-2 text-white">Invite via Link</h2>
                <p class="text-sm text-gray-400 mb-4">Generate a link for users to join as a 'viewer'. The link is valid for 24 hours.</p>
                <div id="inviteBlock" class="hidden space-y-3">
                    <div class="relative">
                        <input id="inviteLinkInput" readonly class="w-full pl-3 pr-16 py-2 rounded-lg border border-slate-700 bg-slate-800 text-sm text-gray-300" />
                        <button id="copyInviteBtn" class="absolute top-1/2 -translate-y-1/2 right-2 text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded font-medium text-white">Copy</button>
                    </div>
                    <button id="regenInviteBtn" class="text-xs text-purple-400 hover:underline">Regenerate link</button>
                </div>
                <button id="genInviteBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white rounded-lg py-2.5 font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                    Generate Invite Link
                </button>
            </div>
            <div class="bg-slate-900/70 backdrop-blur-xl rounded-2xl border border-white/10 p-6">
                <h2 class="text-xl font-semibold mb-4 text-white">Add by User ID</h2>
                <form id="addMemberForm" class="space-y-4">
                    <input id="userIdInput" type="text" placeholder="User ID" required class="w-full px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-white outline-none focus:ring-2 focus:ring-purple-500">
                    <select id="roleInput" class="w-full px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-white outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button id="addMemberBtn" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg">Add Member</button>
                </form>
            </div>
        </section>

        <section>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Current Members</h3>
                <button id="refreshBtn" class="text-xs font-semibold bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded-md border border-white/10">Refresh</button>
            </div>
            <div id="membersLoading" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
                <div class="skeleton h-48 rounded-xl bg-white/5"></div>
                <div class="skeleton h-48 rounded-xl bg-white/5"></div>
                <div class="skeleton h-48 rounded-xl bg-white/5"></div>
            </div>
            <div id="membersError" class="hidden bg-red-900/30 border border-red-500/30 p-6 rounded-xl text-sm">
                <p class="font-semibold text-red-300">Failed to load members.</p>
                <button id="retryBtn" class="mt-3 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold px-3 py-1.5 rounded">Retry</button>
            </div>
            <div id="membersEmpty" class="hidden border-2 border-dashed border-slate-700 rounded-xl p-10 text-center">
                <p class="font-medium text-white">No members yet.</p>
                <p class="text-gray-400 text-sm mt-1">Invite your team to start collaborating.</p>
            </div>
            <div id="membersGrid" class="hidden grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
        </section>
    </div>
  </main>
</div>

<!-- Remove Modal -->
<div id="removeModal" class="fixed inset-0 z-50 flex items-center justify-center px-4 py-8 opacity-0 pointer-events-none">
  <div class="absolute inset-0 bg-black/70 modal-backdrop opacity-0"></div>
  <div class="relative bg-slate-900 rounded-2xl w-full max-w-sm p-6 border border-white/10 modal-content scale-95 opacity-0">
    <h3 class="text-lg font-semibold text-white">Remove Member</h3>
    <p class="text-sm text-gray-400 mt-2">Remove <span id="removeMemberName" class="font-medium text-white"></span> from this project?</p>
    <div class="flex justify-end gap-3 mt-6">
      <button type="button" onclick="closeRemoveModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Cancel</button>
      <button id="confirmRemoveBtn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg text-sm font-semibold">Remove</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-6 right-6 z-[100] hidden opacity-0 transition-opacity duration-300">
  <div id="toastInner" class="px-5 py-2.5 rounded-full text-sm font-medium shadow-2xl"></div>
</div>

<script>
  const token = localStorage.getItem('access_token');
  const projectId = new URLSearchParams(location.search).get('project_id');
  if (!token || !projectId) { location.href = '/'; }

  const ui = {
    themeToggle: document.getElementById('themeToggle'),
    title: document.getElementById('projectTitle'),
    subtitle: document.getElementById('projectSubtitle'),
    inviteBlock: document.getElementById('inviteBlock'),
    inviteInput: document.getElementById('inviteLinkInput'),
    genInviteBtn: document.getElementById('genInviteBtn'),
    regenInviteBtn: document.getElementById('regenInviteBtn'),
    copyInviteBtn: document.getElementById('copyInviteBtn'),
    addForm: document.getElementById('addMemberForm'),
    userIdInput: document.getElementById('userIdInput'),
    roleInput: document.getElementById('roleInput'),
    addBtn: document.getElementById('addMemberBtn'),
    membersLoading: document.getElementById('membersLoading'),
    membersError: document.getElementById('membersError'),
    membersEmpty: document.getElementById('membersEmpty'),
    membersGrid: document.getElementById('membersGrid'),
    retryBtn: document.getElementById('retryBtn'),
    refreshBtn: document.getElementById('refreshBtn'),
    removeModal: document.getElementById('removeModal'),
    removeMemberName: document.getElementById('removeMemberName'),
    confirmRemoveBtn: document.getElementById('confirmRemoveBtn'),
    toast: document.getElementById('toast'),
    toastInner: document.getElementById('toastInner')
  };
  let removeTargetId = null;

  function applyTheme(isDark) { document.documentElement.classList.toggle('dark', isDark); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
  (function initTheme() { const saved = localStorage.getItem('theme'); applyTheme(saved ? saved === 'dark' : true); })();
  ui.themeToggle.addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark')));

  let toastTimer;
  function showToast(msg, type = 'info') {
      clearTimeout(toastTimer);
      ui.toastInner.textContent = msg;
      ui.toastInner.className = "px-5 py-2.5 rounded-full text-sm font-medium shadow-2xl backdrop-blur-sm border";
      if(type === 'error') ui.toastInner.classList.add('bg-red-500/80', 'text-white', 'border-red-400');
      else if(type === 'success') ui.toastInner.classList.add('bg-green-500/80', 'text-white', 'border-green-400');
      else ui.toastInner.classList.add('bg-slate-800/80', 'text-white', 'border-slate-600');
      ui.toast.classList.remove('hidden');
      requestAnimationFrame(() => ui.toast.classList.remove('opacity-0'));
      toastTimer = setTimeout(() => {
        ui.toast.classList.add('opacity-0');
        setTimeout(() => ui.toast.classList.add('hidden'), 300);
      }, 2300);
  }

  const esc = s => String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
  const roleStyles = {
    admin: 'bg-red-500/20 text-red-300 border border-red-500/30',
    editor: 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30',
    viewer: 'bg-blue-500/20 text-blue-300 border border-blue-500/30'
  };

  async function loadProjectMeta() {
    try {
      const res = await fetch('/projects', { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) return;
      const projects = await res.json();
      const project = projects.find(p => String(p.id) === String(projectId));
      if (project) {
        ui.title.textContent = `${project.title} ‚Äì Members`;
        if (project.description) {
          ui.subtitle.textContent = project.description;
          ui.subtitle.classList.remove('hidden');
        }
      }
    } catch (e) { console.error("Failed to load project metadata:", e); }
  }

  async function fetchMembers() {
    showState('loading');
    try {
      const res = await fetch(`/projects/${projectId}/members`, { headers: { Authorization: `Bearer ${token}` } });
      if (res.status === 401) { location.href = '/'; return; }
      if (!res.ok) throw new Error('Failed to fetch members');
      const data = await res.json();
      renderMembers(data);
    } catch (e) { showState('error'); }
  }

  function renderMembers(list) {
    ui.membersGrid.innerHTML = '';
    if (!list || list.length === 0) { showState('empty'); return; }
    list.forEach(m => ui.membersGrid.appendChild(memberCard(m)));
    showState('grid');
  }

  function memberCard(m) {
    const div = document.createElement('div');
    div.className = 'bg-slate-900/70 backdrop-blur-xl rounded-xl border border-white/10 p-4 flex flex-col justify-between';
    div.innerHTML = `
      <div>
        <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center font-semibold text-purple-300 border border-purple-400/30">${esc(m.name.charAt(0).toUpperCase())}</div>
                <div>
                    <p class="font-semibold text-sm text-white truncate max-w-[140px]">${esc(m.name)}</p>
                    <p class="text-xs text-gray-400 truncate max-w-[140px]">${esc(m.email)}</p>
                </div>
            </div>
            <span data-role-badge="${m.user_id}" class="px-2 py-0.5 text-[10px] font-semibold rounded-full ${roleStyles[m.role] || ''}">${esc(m.role)}</span>
        </div>
      </div>
      <div class="flex gap-2 pt-3 mt-auto border-t border-white/10">
          <select data-role-select="${m.user_id}" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-xs text-gray-300 outline-none focus:ring-1 focus:ring-purple-500">
              <option value="viewer" ${m.role === 'viewer' ? 'selected' : ''}>Viewer</option>
              <option value="editor" ${m.role === 'editor' ? 'selected' : ''}>Editor</option>
              <option value="admin" ${m.role === 'admin' ? 'selected' : ''}>Admin</option>
          </select>
          <button data-remove="${m.user_id}" data-name="${esc(m.name)}" class="text-red-400 hover:text-red-300 hover:bg-red-500/10 p-2 rounded-lg" title="Remove">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M5 6v14a2 2 0 002 2h10a2 2 0 002-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
          </button>
      </div>`;
    
    // Using requestAnimationFrame to ensure elements are in the DOM before attaching listeners
    requestAnimationFrame(() => {
        const selectEl = div.querySelector(`[data-role-select="${m.user_id}"]`);
        selectEl?.addEventListener('change', () => updateRole(m.user_id, selectEl.value));
        const removeBtn = div.querySelector(`[data-remove="${m.user_id}"]`);
        removeBtn?.addEventListener('click', () => openRemoveModal(m.user_id, m.name));
    });

    return div;
  }
  
  function showState(state) {
    ['membersLoading', 'membersError', 'membersEmpty', 'membersGrid'].forEach(key => {
        ui[key].classList.add('hidden');
    });
    const el = ui[`members${state.charAt(0).toUpperCase() + state.slice(1)}`];
    if (el) el.classList.remove('hidden');
  }

  ui.addForm.addEventListener('submit', async e => {
    e.preventDefault();
    const id = ui.userIdInput.value.trim();
    const role = ui.roleInput.value;
    if (!/^\d+$/.test(id)) { showToast('Please enter a valid numeric User ID', 'error'); return; }
    ui.addBtn.disabled = true; ui.addBtn.textContent = 'Adding...';
    try {
      const res = await fetch(`/projects/${projectId}/members`, { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ user_id: Number(id), role }) });
      if (!res.ok) { const err = await res.json().catch(()=>({})); throw new Error(err.detail || 'Failed to add member'); }
      showToast('Member added successfully', 'success');
      ui.addForm.reset();
      await fetchMembers();
    } catch (err) { showToast(err.message, 'error'); }
    finally { ui.addBtn.disabled = false; ui.addBtn.textContent = 'Add Member'; }
  });

  async function updateRole(userId, newRole) {
    try {
      const res = await fetch(`/projects/${projectId}/members/${userId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ role: newRole }) });
      if (!res.ok) { const err = await res.json().catch(()=>({})); throw new Error(err.detail || 'Role update failed'); }
      const badge = document.querySelector(`[data-role-badge="${userId}"]`);
      if (badge) { badge.className = `px-2 py-0.5 text-[10px] font-semibold rounded-full ${roleStyles[newRole] || ''}`; badge.textContent = newRole; }
      showToast('Role updated', 'success');
    } catch (err) { showToast(err.message, 'error'); await fetchMembers(); }
  }

  function openRemoveModal(id, name) { removeTargetId = id; ui.removeMemberName.textContent = name; openModal(ui.removeModal); }
  function closeRemoveModal() { closeModal(ui.removeModal); removeTargetId = null; }
  
  ui.confirmRemoveBtn.addEventListener('click', async () => {
    if (!removeTargetId) return;
    ui.confirmRemoveBtn.disabled = true; ui.confirmRemoveBtn.textContent = 'Removing...';
    try {
      const res = await fetch(`/projects/${projectId}/members/${removeTargetId}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) { const err = await res.json().catch(()=>({})); throw new Error(err.detail || 'Failed to remove member'); }
      showToast('Member removed', 'success');
      await fetchMembers();
      closeRemoveModal();
    } catch (err) { showToast(err.message, 'error'); }
    finally { ui.confirmRemoveBtn.disabled = false; ui.confirmRemoveBtn.textContent = 'Remove'; }
  });

  function openModal(m) { m.classList.remove('pointer-events-none', 'opacity-0'); requestAnimationFrame(() => { m.querySelector('.modal-backdrop').classList.remove('opacity-0'); m.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95'); }); }
  function closeModal(m) { m.querySelector('.modal-backdrop').classList.add('opacity-0'); m.querySelector('.modal-content').classList.add('opacity-0', 'scale-95'); setTimeout(() => m.classList.add('pointer-events-none', 'opacity-0'), 250); }

  async function generateInvite() {
    ui.genInviteBtn.disabled = true; ui.genInviteBtn.innerHTML = 'Generating...';
    try {
      const res = await fetch(`/projects/${projectId}/members/invite-link`, { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) throw new Error('Failed to generate invite');
      const { invite_link } = await res.json();
      ui.inviteInput.value = invite_link;
      ui.inviteBlock.classList.remove('hidden');
      ui.genInviteBtn.classList.add('hidden');
      showToast('Invite link generated', 'success');
    } catch(e) {
      showToast('Invite generation failed', 'error');
    } finally {
        // Restore original button state
        ui.genInviteBtn.disabled = false;
        ui.genInviteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg> Generate Invite Link`;
    }
  }

  ui.genInviteBtn.addEventListener('click', generateInvite);
  ui.regenInviteBtn.addEventListener('click', e => { e.preventDefault(); generateInvite(); });
  ui.copyInviteBtn.addEventListener('click', () => { navigator.clipboard.writeText(ui.inviteInput.value).then(() => showToast('Copied to clipboard!', 'success')); });
  
  ui.retryBtn.addEventListener('click', fetchMembers);
  ui.refreshBtn.addEventListener('click', fetchMembers);
  document.addEventListener('keydown', e => { if (e.key === 'Escape' && !ui.removeModal.classList.contains('pointer-events-none')) closeRemoveModal(); });
  ui.removeModal.addEventListener('mousedown', e => { if (e.target === ui.removeModal) closeRemoveModal(); });

  function logout(){
    localStorage.removeItem('access_token');
    fetch('/auth/logout', { method: 'POST' }).finally(() => { window.location.href = '/'; });
  }

  (async function init(){
      await Promise.all([loadProjectMeta(), fetchMembers()]);
      const res = await fetch('/projects', { headers: { Authorization: `Bearer ${token}` } });
      if (res.ok) {
          const projects = await res.json();
          const firstProjectId = projects.length > 0 ? projects[0].id : null;
          const tasksNav = document.getElementById('tasksNav');
          if (tasksNav) {
              tasksNav.onclick = (e) => {
                  e.preventDefault();
                  if(firstProjectId) window.location.href = `/tasks?id=${firstProjectId}`;
                  else showToast('Create a project to view tasks', 'info');
              }
          }
      }
  })();
</script>
</body>
</html>

