<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>Tasks â€“ TeamSync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode:'class', theme:{ extend:{ fontFamily:{ inter:['Inter','sans-serif'] }, colors:{ slate:{950:'#020617'}, cyan:{400:'#22d3ee',500:'#06b6d4'} }, keyframes:{ fadeIn:{'0%':{opacity:'0',transform:'scale(.95)'},'100%':{opacity:'1',transform:'scale(1)'}}, slideUp:{'0%':{opacity:'0',transform:'translateY(10px)'},'100%':{opacity:'1',transform:'translateY(0)'}} }, animation:{ fadeIn:'fadeIn .3s ease-out', slideUp:'slideUp .35s ease-out' } } } };
  </script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(15,23,42,0.72); backdrop-filter: blur(14px); border:1px solid rgba(255,255,255,0.08); }
    .kanban-column::-webkit-scrollbar { width: 6px; }
    .kanban-column::-webkit-scrollbar-track { background: transparent; }
    .kanban-column::-webkit-scrollbar-thumb { background: rgba(71,85,105,.5); border-radius:3px; }
    .task-card.dragging { opacity:.45; transform: scale(1.05); }
    .drag-over { background: rgba(6,182,212,0.12); border-style:dashed; }
    .skeleton { position:relative; overflow:hidden; background:linear-gradient(90deg,#1e293b 25%,#243654 37%,#1e293b 63%); background-size:400% 100%; animation:shimmer 2s infinite; }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:0 0} }
  </style>
</head>
<body class="bg-slate-950 text-gray-200 min-h-screen">

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-5 right-5 px-5 py-3 rounded-lg shadow-lg text-sm font-medium bg-slate-800/90 border border-slate-700 flex items-center gap-3 translate-x-[140%] transition-transform z-50">
    <span id="toastIcon">âš ï¸</span>
    <span id="toastMsg">Message</span>
  </div>

  <!-- Main Container -->
  <div class="min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-screen-2xl mx-auto">
      <!-- Header -->
      <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white" id="projectTitle">ğŸš€ Project</h1>
          <p class="text-sm text-gray-400">Drag & drop tasks or click to edit.</p>
        </div>
        <div class="flex items-center flex-wrap gap-2">
          <button id="addTaskBtn" class="flex items-center gap-2 px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition shadow-lg shadow-cyan-500/20">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Task
          </button>
          <a id="analyticsLink" href="#" class="flex items-center gap-2 px-4 py-2 bg-slate-800/80 text-white rounded-lg hover:bg-slate-700 transition border border-slate-700">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
            Analytics
          </a>
          <a id="membersLink" href="#" class="flex items-center gap-2 px-4 py-2 bg-slate-800/80 text-white rounded-lg hover:bg-slate-700 transition border border-slate-700">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Members
          </a>
          <button id="dashboardBtn" class="flex items-center gap-2 px-4 py-2 bg-slate-800/80 text-white rounded-lg hover:bg-slate-700 transition border border-slate-700" title="Back to Dashboard">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </button>
          <button id="themeToggle" class="flex items-center gap-2 px-4 py-2 bg-slate-800/80 text-white rounded-lg hover:bg-slate-700 transition border border-slate-700" title="Toggle dark mode">ğŸŒ—</button>
        </div>
      </header>

      <!-- Kanban Board -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="board">
        <!-- Column Template Instances -->
        <div class="bg-slate-900/50 rounded-xl border border-slate-800 p-4 flex flex-col" data-status="pending">
          <h2 class="font-semibold mb-4 flex items-center justify-between text-yellow-400">
            <span class="flex items-center gap-2">ğŸ•’ Pending</span>
            <span id="pending-count" class="text-sm bg-yellow-400/10 text-yellow-400 px-2 py-0.5 rounded-full">0</span>
          </h2>
          <div class="flex-1 kanban-column space-y-4 overflow-y-auto p-1 h-96" id="pending-tasks"></div>
          <div class="column-empty hidden text-xs text-gray-500 text-center py-4">No tasks here.</div>
        </div>
        <div class="bg-slate-900/50 rounded-xl border border-slate-800 p-4 flex flex-col" data-status="in-progress">
          <h2 class="font-semibold mb-4 flex items-center justify-between text-blue-400">
            <span class="flex items-center gap-2">ğŸš§ In Progress</span>
            <span id="inprogress-count" class="text-sm bg-blue-400/10 text-blue-400 px-2 py-0.5 rounded-full">0</span>
          </h2>
          <div class="flex-1 kanban-column space-y-4 overflow-y-auto p-1 h-96" id="inprogress-tasks"></div>
          <div class="column-empty hidden text-xs text-gray-500 text-center py-4">No tasks here.</div>
        </div>
        <div class="bg-slate-900/50 rounded-xl border border-slate-800 p-4 flex flex-col" data-status="done">
          <h2 class="font-semibold mb-4 flex items-center justify-between text-green-400">
            <span class="flex items-center gap-2">âœ… Done</span>
            <span id="done-count" class="text-sm bg-green-400/10 text-green-400 px-2 py-0.5 rounded-full">0</span>
          </h2>
            <div class="flex-1 kanban-column space-y-4 overflow-y-auto p-1 h-96" id="done-tasks"></div>
            <div class="column-empty hidden text-xs text-gray-500 text-center py-4">No tasks here.</div>
        </div>
      </div>
      <!-- Global Loading / Error States -->
      <div id="loadingState" class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
        <div class="space-y-4"> <div class="skeleton h-24 rounded-lg"></div><div class="skeleton h-24 rounded-lg"></div></div>
        <div class="space-y-4"> <div class="skeleton h-24 rounded-lg"></div><div class="skeleton h-24 rounded-lg"></div></div>
        <div class="space-y-4"> <div class="skeleton h-24 rounded-lg"></div><div class="skeleton h-24 rounded-lg"></div></div>
      </div>
      <div id="errorState" class="hidden mt-8 text-center text-red-400 text-sm">Failed to load tasks. <button id="retryBtn" class="underline">Retry</button></div>
    </div>
  </div>

  <!-- Add/Edit Task Modal -->
  <div id="taskModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-40 animate-fadeIn">
    <div class="glass p-6 rounded-xl w-full max-w-md shadow-2xl m-4 border border-slate-700">
      <h3 id="modalTitle" class="text-xl font-bold mb-6 text-white">Add New Task</h3>
      <div class="space-y-4">
        <input id="taskTitleInput" placeholder="Task Title" class="w-full px-4 py-2 rounded-lg bg-slate-800/80 border border-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none text-white" />
        <textarea id="taskDescInput" placeholder="Description" class="w-full px-4 py-2 rounded-lg bg-slate-800/80 border border-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none text-white" rows="3"></textarea>
        <div>
          <label class="text-xs uppercase tracking-wide text-gray-400">Due Date</label>
          <input type="date" id="taskDueInput" class="mt-1 w-full px-4 py-2 rounded-lg bg-slate-800/80 border border-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none text-white" />
        </div>
        <div>
          <label class="text-xs uppercase tracking-wide text-gray-400">Status</label>
          <select id="taskStatusInput" class="mt-1 w-full px-4 py-2 rounded-lg bg-slate-800/80 border border-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none text-white">
            <option value="pending">Pending</option>
            <option value="in-progress">In Progress</option>
            <option value="done">Done</option>
          </select>
        </div>
        <div id="fileUploadContainer">
          <label class="text-xs uppercase tracking-wide text-gray-400">Attachment</label>
          <input type="file" id="taskFileInput" class="mt-1 w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-cyan-500/10 file:text-cyan-400 hover:file:bg-cyan-500/20" />
        </div>
      </div>
      <div class="flex justify-end gap-4 mt-8">
        <button id="cancelModalBtn" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition">Cancel</button>
        <button id="modalSubmitButton" class="px-4 py-2 bg-cyan-500 text-white rounded-lg hover:bg-cyan-600 transition">Save</button>
      </div>
    </div>
  </div>

  <script>
    // -------------- Core State & Elements --------------
    const token = localStorage.getItem('access_token');
    const qs = new URLSearchParams(location.search); 
    const projectId = qs.get('id');
    if(!token || !projectId){ location.href='/'; }

    const ui = {
      projectTitle: document.getElementById('projectTitle'),
      analyticsLink: document.getElementById('analyticsLink'),
      membersLink: document.getElementById('membersLink'),
      addTaskBtn: document.getElementById('addTaskBtn'),
      taskModal: document.getElementById('taskModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalSubmit: document.getElementById('modalSubmitButton'),
      cancelModal: document.getElementById('cancelModalBtn'),
      fileUploadContainer: document.getElementById('fileUploadContainer'),
      titleInput: document.getElementById('taskTitleInput'),
      descInput: document.getElementById('taskDescInput'),
      dueInput: document.getElementById('taskDueInput'),
      statusInput: document.getElementById('taskStatusInput'),
      fileInput: document.getElementById('taskFileInput'),
      loadingState: document.getElementById('loadingState'),
      errorState: document.getElementById('errorState'),
      retryBtn: document.getElementById('retryBtn'),
      themeToggle: document.getElementById('themeToggle'),
      dashboardBtn: document.getElementById('dashboardBtn'),
      toast: document.getElementById('toast'),
      toastMsg: document.getElementById('toastMsg'),
      toastIcon: document.getElementById('toastIcon'),
      columns: {
        pending: document.getElementById('pending-tasks'),
        'in-progress': document.getElementById('inprogress-tasks'),
        done: document.getElementById('done-tasks')
      },
      counts: {
        pending: document.getElementById('pending-count'),
        'in-progress': document.getElementById('inprogress-count'),
        done: document.getElementById('done-count')
      }
    };

    let editingTaskId = null;
    let toastTimer;

    // -------------- Theme --------------
    function initTheme(){
      const stored = localStorage.getItem('theme');
      const prefers = matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = stored ? stored==='dark' : prefers;
      document.documentElement.classList.toggle('dark', isDark);
      ui.themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ—';
    }
    ui.themeToggle.onclick = () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark?'dark':'light');
      ui.themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ—';
    };

    // -------------- Toast --------------
    function showToast(msg,type='info'){
      clearTimeout(toastTimer);
      const colors = { info:['âš ï¸','bg-slate-800/90'], success:['âœ…','bg-green-600/90'], error:['â›”','bg-red-600/90'] };
      const [icon, bg] = colors[type]||colors.info;
      ui.toastIcon.textContent = icon;
      ui.toastMsg.textContent = msg;
      ui.toast.className = ui.toast.className.replace(/bg-[^ ]+/g,'');
      ui.toast.classList.remove('translate-x-[140%]');
      ui.toast.classList.add(bg,'translate-x-0');
      toastTimer = setTimeout(()=> ui.toast.classList.add('translate-x-[140%]'), 3200);
    }

    // -------------- Modal Helpers --------------
    function openModal(mode='add', task=null){
      editingTaskId = mode==='edit' ? task.id : null;
      ui.modalTitle.textContent = mode==='edit' ? 'Edit Task' : 'Add New Task';
      ui.modalSubmit.textContent = mode==='edit' ? 'Save Changes' : 'Create Task';
      ui.titleInput.value = task?.title || '';
      ui.descInput.value = task?.description || '';
      ui.dueInput.value = task?.due_date ? task.due_date.split('T')[0] : '';
      ui.statusInput.value = task?.status || 'pending';
      ui.fileUploadContainer.style.display = mode==='edit' ? 'none':'block';
      ui.taskModal.classList.remove('hidden');
      ui.taskModal.classList.add('flex');
    }
    function closeModal(){
      ui.taskModal.classList.add('hidden');
      ui.taskModal.classList.remove('flex');
    }
    ui.cancelModal.onclick = closeModal;
    ui.addTaskBtn.onclick = ()=> openModal('add');

    // -------------- API Calls --------------
    async function fetchProject(){
      const res = await fetch('/projects', { headers:{ Authorization:'Bearer '+token }});
      if(!res.ok) throw new Error('Projects fetch failed');
      const projects = await res.json();
      const project = projects.find(p=> p.id == projectId);
      ui.projectTitle.textContent = 'ğŸš€ ' + (project?.title || 'Project');
    }

    async function listTasks(){
      const res = await fetch(`/projects/${projectId}/tasks`, { headers:{ Authorization:'Bearer '+token }});
      if(!res.ok) throw new Error('Tasks fetch failed');
      return res.json();
    }

    async function createTask(){
      const fd = new FormData();
      fd.append('title', ui.titleInput.value.trim());
      fd.append('description', ui.descInput.value.trim());
      fd.append('status', ui.statusInput.value);
      if(ui.dueInput.value) fd.append('due_date', ui.dueInput.value);
      if(ui.fileInput.files[0]) fd.append('file', ui.fileInput.files[0]);
      const res = await fetch(`/projects/${projectId}/tasks`, { method:'POST', headers:{ Authorization:'Bearer '+token }, body: fd });
      if(!res.ok) throw new Error('Create failed');
      return res.json();
    }

    async function updateTask(id, payload){
      const res = await fetch(`/tasks/${id}`, { method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error('Update failed');
      return res.json();
    }

    async function removeTask(id){
      const res = await fetch(`/tasks/${id}`, { method:'DELETE', headers:{ Authorization:'Bearer '+token }});
      if(!res.ok) throw new Error('Delete failed');
    }

    async function listComments(taskId){
      const res = await fetch(`/tasks/${taskId}/comments`, { headers:{ Authorization:'Bearer '+token }});
      if(!res.ok) return [];
      return res.json();
    }
    async function addComment(taskId, content){
      const res = await fetch(`/tasks/${taskId}/comments`, { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ content }) });
      if(!res.ok) throw new Error('Comment failed');
      return res.json();
    }

    // -------------- Rendering --------------
    function clearBoard(){ Object.values(ui.columns).forEach(c=> c.innerHTML=''); }
    function updateCounts(counts){ Object.entries(counts).forEach(([k,v])=> ui.counts[k].textContent = v); }
    function showLoading(on){ ui.loadingState.classList.toggle('hidden', !on); document.getElementById('board').classList.toggle('opacity-30', on); }

    function createTaskCard(task){
      const card = document.createElement('div');
      card.className = 'task-card p-4 rounded-lg bg-slate-800/80 border border-slate-700 cursor-grab active:cursor-grabbing animate-slideUp group';
      card.draggable = true; card.dataset.taskId = task.id; card.dataset.status = task.status;
      const dueDate = task.due_date ? task.due_date.split('T')[0] : null;
      const overdue = dueDate && new Date(dueDate) < new Date();
      const attachments = (task.attachments||[]).map(a=>{
        const fn = a.filename || '';
        const display = fn.includes('_') ? fn.substring(fn.indexOf('_')+1) : fn;
        return `<a href="/uploads/${fn}" download class="text-xs text-cyan-400 hover:underline flex items-center gap-1">ğŸ“ ${display}</a>`;
      }).join('');
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-semibold text-gray-100 pr-2 leading-snug break-words">${task.title}</h3>
          <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
            <button class="edit-btn text-gray-400 hover:text-cyan-400" title="Edit">âœï¸</button>
            <button class="del-btn text-gray-400 hover:text-red-400" title="Delete">ğŸ—‘ï¸</button>
          </div>
        </div>
        <p class="text-xs text-gray-400 mb-3 whitespace-pre-line">${task.description || 'â€”'}</p>
        <div class="flex flex-wrap gap-3 text-[11px] items-center border-t border-slate-700/60 pt-2">
          ${dueDate ? `<span class="px-2 py-0.5 rounded-full ${overdue?'bg-red-500/20 text-red-300':'bg-slate-700 text-slate-300'}">ğŸ“… ${dueDate}</span>`:''}
          <button class="toggle-comments text-cyan-400 hover:underline">Comments (${task.comments?.length||0})</button>
        </div>
        <div class="attachments space-y-1 mt-2">${attachments}</div>
        <div class="comments hidden mt-3 space-y-2"></div>
      `;
      // Edit/Delete handlers
      card.querySelector('.edit-btn').onclick = ()=> openModal('edit', task);
      card.querySelector('.del-btn').onclick = async ()=> { if(confirm('Delete this task?')) { try { await removeTask(task.id); showToast('Task deleted','success'); await reloadBoard(); } catch(e){ showToast(e.message,'error'); } } };
      // Comments toggle
      const commentsContainer = card.querySelector('.comments');
      card.querySelector('.toggle-comments').onclick = async ()=>{
        if(!commentsContainer.classList.contains('hidden')) { commentsContainer.classList.add('hidden'); return; }
        commentsContainer.innerHTML = '<div class="text-xs text-slate-400">Loadingâ€¦</div>';
        commentsContainer.classList.remove('hidden');
        const comments = await listComments(task.id);
        renderComments(commentsContainer, task.id, comments);
      };
      // Drag events
      card.addEventListener('dragstart', dragStart);
      return card;
    }

    function renderComments(container, taskId, comments){
      container.innerHTML='';
      if(!comments.length){ container.innerHTML = '<div class="text-xs text-slate-500">No comments yet.</div>'; }
      comments.forEach(c=>{
        const row = document.createElement('div');
        row.className='bg-slate-700/70 px-2 py-1 rounded text-[11px] flex gap-1';
        row.innerHTML = `<strong class="text-cyan-300">${c.user_name}:</strong><span class="flex-1 text-slate-200">${c.content}</span>`;
        container.appendChild(row);
      });
      const form = document.createElement('form');
      form.className='flex gap-2 mt-1';
      form.innerHTML = `<input class="flex-1 bg-slate-800/80 border border-slate-600 rounded px-2 py-1 text-[11px] outline-none focus:ring-1 focus:ring-cyan-500" placeholder="Add comment" /><button class="px-2 bg-cyan-600 text-white rounded text-[11px]">Add</button>`;
      form.onsubmit = async e=>{ e.preventDefault(); const val=form.querySelector('input').value.trim(); if(!val) return; try { await addComment(taskId,val); const updated=await listComments(taskId); renderComments(container, taskId, updated); } catch(err){ showToast(err.message,'error'); } };
      container.appendChild(form);
    }

    async function reloadBoard(){
      try {
        showLoading(true); ui.errorState.classList.add('hidden');
        const tasks = await listTasks();
        clearBoard(); const counts={ 'pending':0,'in-progress':0,'done':0 };
        tasks.forEach(t=>{ counts[t.status]++; ui.columns[t.status].appendChild(createTaskCard(t)); });
        updateCounts(counts);
        updateEmptyPlaceholders();
      } catch(err){ ui.errorState.classList.remove('hidden'); showToast(err.message,'error'); }
      finally { showLoading(false); }
    }

    function updateEmptyPlaceholders(){
      document.querySelectorAll('[data-status]').forEach(col=>{
        const list = col.querySelector('.kanban-column');
        const emptyEl = col.querySelector('.column-empty');
        if(!list || !emptyEl){
          console.warn('Kanban column missing expected child elements', {col, listExists: !!list, emptyExists: !!emptyEl});
          return; // safeguard to avoid null.classList errors
        }
        emptyEl.classList.toggle('hidden', list.children.length>0);
      });
    }

    // -------------- Drag & Drop --------------
    let dragged=null; let originStatus=null; let originIndex=null;
    function dragStart(e){ dragged=e.currentTarget; originStatus=dragged.dataset.status; originIndex=[...dragged.parentElement.children].indexOf(dragged); e.dataTransfer.effectAllowed='move'; setTimeout(()=> dragged.classList.add('dragging'),0); }
    document.querySelectorAll('.kanban-column').forEach(col=>{
      col.addEventListener('dragover', e=>{ e.preventDefault(); col.classList.add('drag-over'); });
      col.addEventListener('dragleave', ()=> col.classList.remove('drag-over'));
      col.addEventListener('drop', async e=>{
        e.preventDefault(); col.classList.remove('drag-over'); if(!dragged) return; const newStatus = col.parentElement.getAttribute('data-status');
        if(newStatus===dragged.dataset.status){ dragged.classList.remove('dragging'); dragged=null; return; }
        col.appendChild(dragged); const taskId=dragged.dataset.taskId; dragged.dataset.status=newStatus; // optimistic
        try { await updateTask(taskId,{ status:newStatus }); showToast('Status updated','success'); await reloadBoard(); }
        catch(err){ showToast('Update failed, reverting','error'); // rollback
          const originCol = document.querySelector(`[data-status="${originStatus}"] .kanban-column`);
          if(originCol){ const children=[...originCol.children]; if(originIndex>=children.length) originCol.appendChild(dragged); else originCol.insertBefore(dragged, children[originIndex]); dragged.dataset.status=originStatus; }
        }
        finally { dragged.classList.remove('dragging'); dragged=null; }
      });
    });

    // -------------- Modal Submit --------------
    ui.modalSubmit.onclick = async ()=>{
      try {
        if(!ui.titleInput.value.trim()) { showToast('Title required','error'); return; }
        if(editingTaskId){ await updateTask(editingTaskId,{ title: ui.titleInput.value.trim(), description: ui.descInput.value.trim(), status: ui.statusInput.value, due_date: ui.dueInput.value || null }); showToast('Task updated','success'); }
        else { await createTask(); showToast('Task created','success'); }
        closeModal(); await reloadBoard();
      } catch(err){ showToast(err.message,'error'); }
    };

    // -------------- Navigation Links --------------
    ui.analyticsLink.href = `/analytics?id=${projectId}`;
    ui.membersLink.href = `/members?project_id=${projectId}`;
    ui.dashboardBtn.onclick = ()=> location.href='/dashboard';
    ui.retryBtn && (ui.retryBtn.onclick = reloadBoard);

    // -------------- Init --------------
    (async function init(){
      initTheme();
      try { await fetchProject(); } catch(e){ showToast('Project load failed','error'); }
      await reloadBoard();
    })();
  </script>
</body>
</html>
